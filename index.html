<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MíšaXYZ Viewer</title>
  <!-- Favicon -->
  <link rel="icon" type="image/png" href="rgfavicon.png">

  <!-- 3Dmol.js (custom build) -->
  <script src="./3Dmol-min-misaxyz.js"></script>

  <!-- Fonts -->
  <style>
    @font-face {
      font-family: "Inter";
      src: url("Inter-Regular.woff2") format("woff2");
      font-weight: 400;
      font-display: swap;
    }

    @font-face {
      font-family: "Inter";
      src: url("Inter-SemiBold.woff2") format("woff2");
      font-weight: 600;
      font-display: swap;
    }

    @font-face {
      font-family: "Inter";
      src: url("Inter-Bold.woff2") format("woff2");
      font-weight: 700;
      font-display: swap;
    }

    /* --------------------------------------------------
       CSS Custom Properties
    -------------------------------------------------- */
    :root {
      --bg:              #f0f4ff;
      --bg-grad-start:   #d9f5f5;
      --bg-grad-end:     #f9fafb;
      --card:            rgba(255, 255, 255, 0.65);
      --accent:          #008081;
      --accent-muted:    #d5f0f0;
      --text:            #1f2937;
      --muted:           #6b7280;
      --radius:          12px;
      --shadow:          0 10px 25px rgba(0, 0, 0, 0.07);
    }

    /* --------------------------------------------------
       Global reset
    -------------------------------------------------- */
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: "Inter", "Segoe UI", Arial, sans-serif;
    }

    html, body { height: 100%; }
    body { zoom: 0.95; }

    /* --------------------------------------------------
       Layout
    -------------------------------------------------- */
    body {
      display: flex;
      flex-direction: column;
      color: var(--text);
      background: var(--bg);
    }

    /* Background gradient */
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background: linear-gradient(130deg, var(--bg-grad-start) 0%, var(--bg-grad-end) 70%);
      z-index: -2;
    }

    main {
      flex: 1;
      display: flex;
      overflow: hidden;
      animation: fadeIn 0.6s ease 0.1s both;
    }

    /* Sidebar --------------------------------------------------------- */
    #sidebar {
      width: 280px;
      max-width: 65%;
      display: flex;
      flex-direction: column;
      backdrop-filter: blur(14px) saturate(160%);
      background: var(--card);
      box-shadow: var(--shadow);
      border-right: 1px solid rgba(0, 0, 0, 0.05);
    }

    #fileSection {
      padding: 16px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.06);
    }

    #rgLogo {
      display: block;
      margin: 0 0 13px 0;
      width: 140px;
      max-width: 80%;
      height: auto;
    }

    #fileBtn {
      width: 100%;
      padding: 10px 18px;
      font-weight: 600;
      font-size: 15px;
      border: none;
      border-radius: var(--radius);
      background: var(--accent);
      color: #fff;
      cursor: pointer;
      transition: transform 0.18s ease, box-shadow 0.18s ease;
    }

    #fileBtn:hover {
      transform: translateY(-2px) scale(1.02);
      box-shadow: 0 6px 14px rgba(0, 128, 129, 0.25);
    }

    #fileBtn:active {
      transform: translateY(0) scale(1);
    }

    #sidebar header {
      padding: 18px 16px;
      font-size: 17px;
      font-weight: 700;
      letter-spacing: -0.01em;
      color: var(--text);
    }

    /* Molecule list */
    #molList {
      flex: 1;
      padding: 0 10px;
      overflow-y: auto;
      scroll-behavior: smooth;
    }

    #molList button {
      width: 100%;
      text-align: left;
      background: transparent;
      border: none;
      padding: 12px 14px;
      border-radius: var(--radius);
      font-size: 15px;
      cursor: pointer;
      transition: background 0.15s ease, transform 0.15s ease;
    }

    #molList button:hover            { background: var(--accent-muted); }
    #molList button.active           { background: var(--accent); color: #fff; }

    /* Custom scrollbar */
    #molList::-webkit-scrollbar       { width: 6px; }
    #molList::-webkit-scrollbar-track { background: transparent; }
    #molList::-webkit-scrollbar-thumb { background: rgba(0, 0, 0, 0.1); border-radius: 3px; }

    /* Controls under the list */
    #controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      padding: 16px;
      border-top: 1px solid rgba(0, 0, 0, 0.06);
    }

    #controls button {
      flex: 1 1 48%;
      padding: 10px;
      border: none;
      border-radius: var(--radius);
      font-size: 14px;
      font-weight: 600;
      background: #e5e7eb;
      color: var(--text);
      cursor: pointer;
      transition: background 0.15s ease, transform 0.18s ease, box-shadow 0.18s ease;
    }

    #controls button:hover  {
      background: #d1d5db;
      transform: translateY(-1.5px) scale(1.02);
      box-shadow: 0 5px 12px rgba(0, 128, 129, 0.18);
    }

    #controls button:active { transform: translateY(0) scale(1); }
    #controls button.active { background: var(--accent); color: #fff; }

    /* Viewer ---------------------------------------------------------- */
    #viewerContainer {
      flex: 1;
      position: relative;
      min-width: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #viewer        { width: 100%; height: 100%; }

    #formulaLabel {
      position: absolute;
      bottom: 12px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(8px);
      padding: 6px 14px;
      border-radius: var(--radius);
      font-weight: 600;
      font-size: 15px;
      color: var(--text);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.06);
      pointer-events: none;
    }

    /* Footer ---------------------------------------------------------- */
    footer {
      padding: 12px 16px;
      font-size: 13px;
      text-align: center;
      color: var(--muted);
    }

    /* Animations ------------------------------------------------------ */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to   { opacity: 1; transform: none;          }
    }
  </style>
</head>
<body>
  <main>
    <!-- ================== Sidebar ================== -->
    <aside id="sidebar">
      <!-- File loader -->
      <div id="fileSection">
        <img id="rgLogo" src="rglogo.avif" alt="Roithová Group logo">
        <input type="file" id="fileInput" accept=".xyz" hidden>
        <button id="fileBtn">Open .xyz</button>
      </div>

      <!-- Molecule list -->
      <header>Molecules</header>
      <div id="molList"></div>

      <!-- Style and label controls -->
      <div id="controls">
        <button id="styleBtn">Style: Stick</button>
        <button id="labelMode">Labels: Off</button>
      </div>
    </aside>

    <!-- ================== Viewer ================== -->
    <section id="viewerContainer">
      <div id="viewer"></div>
      <div id="formulaLabel"></div>
    </section>
  </main>

  <footer>MíšaXYZ v1.6 · RSI 2025 · Roithová Group</footer>

  <!-- ===============================================================
       JavaScript
  =============================================================== -->
  <script>
    /* --------------------------------------------------------------
       Periodic table helpers
    -------------------------------------------------------------- */
    const SYMBOLS = [
      "", "H", "He", "Li", "Be", "B",  "C",  "N",  "O",  "F",  "Ne",
      "Na", "Mg", "Al", "Si", "P",  "S",  "Cl", "Ar", "K",  "Ca", "Sc", "Ti",
      "V",  "Cr", "Mn", "Fe", "Co", "Ni", "Cu", "Zn", "Ga", "Ge", "As", "Se", "Br",
      "Kr", "Rb", "Sr", "Y",  "Zr", "Nb", "Mo", "Tc", "Ru", "Rh", "Pd", "Ag", "Cd",
      "In", "Sn", "Sb", "Te", "I",  "Xe", "Cs", "Ba", "La", "Ce", "Pr", "Nd", "Pm",
      "Sm", "Eu", "Gd", "Tb", "Dy", "Ho", "Er", "Tm", "Yb", "Lu", "Hf", "Ta", "W",  "Re",
      "Os", "Ir", "Pt", "Au", "Hg", "Tl", "Pb", "Bi", "Po", "At", "Rn", "Fr", "Ra", "Ac",
      "Th", "Pa", "U",  "Np", "Pu", "Am", "Cm", "Bk", "Cf", "Es", "Fm", "Md", "No", "Lr",
      "Rf", "Db", "Sg", "Bh", "Hs", "Mt", "Ds", "Rg", "Cn", "Nh", "Fl", "Mc", "Lv", "Ts", "Og"
    ];

    // A quick lookup list for colourised metals
    const METALS = [
      "Li", "Be", "Na", "Mg", "Al", "K",  "Ca", "Sc", "Ti", "V",  "Cr", "Mn", "Fe", "Co", "Ni",
      "Cu", "Zn", "Ga", "Rb", "Sr", "Y",  "Zr", "Nb", "Mo", "Tc", "Ru", "Rh", "Pd", "Ag", "Cd",
      "In", "Sn", "Cs", "Ba", "La", "Ce", "Pr", "Nd", "Pm", "Sm", "Eu", "Gd", "Tb", "Dy", "Ho", "Er",
      "Tm", "Yb", "Lu", "Hf", "Ta", "W",  "Re", "Os", "Ir", "Pt", "Au", "Hg", "Tl", "Pb", "Bi", "Po",
      "Fr", "Ra", "Ac", "Th", "Pa", "U",  "Np", "Pu", "Am", "Cm", "Bk", "Cf", "Es", "Fm", "Md", "No",
      "Lr", "Rf", "Db", "Sg", "Bh", "Hs", "Mt", "Ds", "Rg", "Cn"
    ];

    /* --------------------------------------------------------------
       DOM references
    -------------------------------------------------------------- */
    const fileBtn       = document.getElementById("fileBtn");
    const fileInput     = document.getElementById("fileInput");
    const molList       = document.getElementById("molList");
    const labelModeBtn  = document.getElementById("labelMode");
    const styleBtn      = document.getElementById("styleBtn");
    const formulaLabel  = document.getElementById("formulaLabel");

    /* --------------------------------------------------------------
       Initialise 3Dmol viewer
    -------------------------------------------------------------- */
    const viewer = $3Dmol.createViewer("viewer", { backgroundColor: "white" });
    viewer.enableFog(true);
    if (viewer.setFog) {
      viewer.setFog(0.3, 1.0);
    }

    /* --------------------------------------------------------------
       Application state
    -------------------------------------------------------------- */
    let molecules     = [];  // Parsed molecules from the XYZ file
    let currentIndex  = -1;  // Index of the currently displayed molecule
    let labelMode     = 0;   // 0 = off, 1 = element, 2 = atom number
    let styleMode     = 0;   // 0 = stick, 1 = ball + stick

    const STYLE_NAMES = ["stick", "ballstick"];
    const STYLE_TEXT  = ["Style: Stick", "Style: Ball & Stick"];
    const MODE_TEXT   = ["Labels: Off", "Labels: Atom", "Labels: Number"];

    // -----------------------------------------------------------------
    // Utility: update button text
    // -----------------------------------------------------------------
    const updateStyleText = () => styleBtn.textContent  = STYLE_TEXT[styleMode];
    const updateModeText  = () => labelModeBtn.textContent = MODE_TEXT[labelMode];

    updateStyleText();
    updateModeText();

    /* --------------------------------------------------------------
       File loading
    -------------------------------------------------------------- */
    fileBtn.addEventListener("click", () => fileInput.click());

    fileInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = ({ target }) => {
        try {
          molecules = parseXYZ(target.result);
          buildMoleculeList();
          if (molecules.length) showMolecule(0);
        } catch (err) {
          alert(err.message ?? err);
        }
      };

      reader.readAsText(file);
    });

    /* --------------------------------------------------------------
       XYZ file parser
    -------------------------------------------------------------- */
    function parseXYZ(text) {
      const lines = text.replace(/\r/g, "").split("\n");
      const mols  = [];
      let i = 0;

      while (i < lines.length) {
        // Skip blank lines
        while (i < lines.length && lines[i].trim() === "") i++;
        if (i >= lines.length) break;

        const atomCount = parseInt(lines[i], 10);
        if (isNaN(atomCount) || atomCount <= 0) {
          throw new Error(`Invalid atom count on line ${i + 1}`);
        }

        const header = (lines[i + 1] ?? "").trim();
        const atoms  = [];
        const xyzLines = [];

        for (let j = 0; j < atomCount; j++) {
          const line = lines[i + 2 + j];
          if (!line) throw new Error("Unexpected end of file while reading atoms");

          const parts = line.trim().split(/\s+/);
          if (parts.length < 4) {
            throw new Error(`Bad atom line on ${i + 3 + j}`);
          }

          // Element symbol can be a number (atomic number) or a symbol itself
          let elem = parts[0];
          if (/^\d+$/.test(elem)) {
            elem = SYMBOLS[parseInt(elem, 10)] ?? "X";
          }

          const x = parseFloat(parts[1]);
          const y = parseFloat(parts[2]);
          const z = parseFloat(parts[3]);

          xyzLines.push(`${elem} ${x} ${y} ${z}`);
          atoms.push({ elem, x, y, z });
        }

        mols.push({
          header,
          atoms,
          xyz: `${atomCount}\n${header}\n${xyzLines.join("\n")}\n`,
        });

        i += atomCount + 2; // Move index to the next molecule block
      }

      return mols;
    }

    /* --------------------------------------------------------------
       UI helpers
    -------------------------------------------------------------- */
    function buildMoleculeList() {
      molList.innerHTML = "";

      molecules.forEach((mol, idx) => {
        const btn = document.createElement("button");
        btn.textContent = `${idx + 1}. ${mol.header || "Molecule"}`;
        btn.addEventListener("click", () => showMolecule(idx));
        molList.appendChild(btn);
      });
    }

    /* --------------------------------------------------------------
       Viewer updates
    -------------------------------------------------------------- */
    function showMolecule(index) {
      if (index < 0 || index >= molecules.length) return;
      currentIndex = index;

      // Highlight active button
      [...molList.children].forEach((btn, idx) => btn.classList.toggle("active", idx === index));

      // Reset viewer
      viewer.removeAllLabels();
      viewer.removeAllModels();

      const model = viewer.addModel(molecules[index].xyz, "xyz");
      applyStyle(model);
      drawLabels(model);
      viewer.zoomTo();
      viewer.render();

      updateFormula();
    }

    // -----------------------------------------------------------------
    // Style application
    // -----------------------------------------------------------------
    function applyStyle(model) {
      if (!model) return;
      model.setStyle({}, {}); // Clear existing style

      const stick  = { radius: 0.15 };
      const sphere = { scale: 0.25 };
      const isStickMode = STYLE_NAMES[styleMode] === "stick";

      if (isStickMode) {
        model.setStyle({}, { stick });
      } else {
        model.setStyle({}, { stick, sphere });
        // Smaller spheres for hydrogens
        model.setStyle({ elem: "H" }, { stick, sphere: { scale: 0.15 } });
      }

      // Element colouring
      const addColour = (selector, colour) => {
        if (isStickMode) {
          model.setStyle(selector, { stick: { ...stick, color: colour } });
        } else {
          model.setStyle(selector, {
            stick:  { ...stick,  color: colour },
            sphere: { ...sphere, color: colour },
          });
        }
      };

      addColour({ elem: "N" }, "#3b82f6"); // Blue for nitrogen
      addColour({ elem: "F" }, "#006400"); // Dark green for fluorine
      METALS.forEach(el => addColour({ elem: el }, "orange"));
    }

    styleBtn.addEventListener("click", () => {
      styleMode = (styleMode + 1) % STYLE_NAMES.length;
      updateStyleText();
      if (currentIndex !== -1) {
        showMolecule(currentIndex);
      }
    });

    // -----------------------------------------------------------------
    // Labels
    // -----------------------------------------------------------------
    function drawLabels(model) {
      if (!model || labelMode === 0) return;

      model.selectedAtoms({}).forEach((atom, idx) => {
        const text = labelMode === 2 ? String(idx + 1) : atom.elem;
        viewer.addLabel(text, {
          position: { x: atom.x, y: atom.y, z: atom.z },
          fontSize: 12,
          fontColor: "#000",
          showBackground: false,
        });
      });
    }

    labelModeBtn.addEventListener("click", () => {
      labelMode = (labelMode + 1) % 3;
      updateModeText();
      if (currentIndex !== -1) {
        showMolecule(currentIndex);
      }
    });

    /* --------------------------------------------------------------
       Formula under the viewer
    -------------------------------------------------------------- */
    function updateFormula() {
      const mol = molecules[currentIndex];
      if (!mol) {
        formulaLabel.textContent = "";
        return;
      }

      const counts = {};
      mol.atoms.forEach(({ elem }) => {
        counts[elem] = (counts[elem] ?? 0) + 1;
      });

      // Ordering: C, then H, then alphabetical
      const sortedKeys = Object.keys(counts).sort((a, b) => {
        if (a === "C") return -1;
        if (b === "C") return  1;
        if (a === "H") return b === "C" ? 1 : -1;
        if (b === "H") return a === "C" ? -1 : 1;
        return a.localeCompare(b);
      });

      formulaLabel.textContent = sortedKeys
        .map(k => k + (counts[k] > 1 ? counts[k] : ""))
        .join(" ");
    }

    /* --------------------------------------------------------------
       Keep viewer responsive
    -------------------------------------------------------------- */
    window.addEventListener("resize", () => viewer.resize());
  </script>
</body>
</html>
