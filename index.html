<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>MíšaXYZ Viewer</title>
  <script src="./3Dmol-min-misaxyz.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    /***********  THEME  ***********/
    :root{
      --bg:#f0f4ff;
      --bg-grad-start:#d9f5f5; /* light teal gradient start */
      --bg-grad-end:#f9fafb;
      --card:rgba(255,255,255,0.65);
      --accent:#008081; /* requested teal */
      --accent-muted:#d5f0f0; /* pale teal for hover */
      --text:#1f2937;
      --muted:#6b7280;
      --radius:12px;
      --shadow:0 10px 25px rgba(0,0,0,0.07);
    }

    /***********  RESET  ***********/
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0;font-family:'Inter',Segoe UI,Arial,sans-serif}
    html,body{height:100%;}

    /* Shrink entire UI */
    body{zoom:0.95;}

    /***********  LAYOUT  ***********/
    body{
      display:flex;
      flex-direction:column;
      color:var(--text);
      background:var(--bg);
    }
    /* soft gradient backdrop */
    body::before{
      content:"";
      position:fixed;inset:0;
      background:linear-gradient(130deg,var(--bg-grad-start) 0%,var(--bg-grad-end) 70%);
      z-index:-2;
    }

    main{flex:1;display:flex;overflow:hidden;animation:fadeIn 0.6s ease 0.1s both}

    /***********  SIDEBAR  ***********/
    #sidebar{
      width:280px;max-width:65%;
      display:flex;flex-direction:column;
      backdrop-filter:blur(14px) saturate(160%);
      background:var(--card);
      box-shadow:var(--shadow);
      border-right:1px solid rgba(0,0,0,0.05);
    }

    #fileSection{padding:16px;border-bottom:1px solid rgba(0,0,0,0.06);}

    /* Roithová Group logo */
    #rgLogo{
      display:block;
      margin:0 0 15px 0; /* left‑aligned + more space below */
      width:140px;
      max-width:80%;
      height:auto;
    }

    #fileBtn{
      width:100%;padding:10px 18px;font-weight:600;font-size:15px;
      border:none;border-radius:var(--radius);
      background:var(--accent);color:#fff;cursor:pointer;
      transition:transform .18s ease,box-shadow .18s ease;
    }
    #fileBtn:hover{transform:translateY(-2px) scale(1.02);box-shadow:0 6px 14px rgba(0,128,129,0.25)}
    #fileBtn:active{transform:translateY(0) scale(1)}

    #sidebar header{padding:18px 16px;font-size:17px;font-weight:700;letter-spacing:-0.01em;color:var(--text)}

    #molList{flex:1;padding:0 10px;overflow-y:auto;scroll-behavior:smooth}
    #molList button{
      width:100%;text-align:left;background:transparent;border:none;
      padding:12px 14px;border-radius:var(--radius);
      font-size:15px;cursor:pointer;
      transition:background .15s ease,transform .15s ease;
    }
    #molList button:hover{background:var(--accent-muted)}
    #molList button.active{background:var(--accent);color:#fff}

    /* nicer scrollbar */
    #molList::-webkit-scrollbar{width:6px}
    #molList::-webkit-scrollbar-track{background:transparent}
    #molList::-webkit-scrollbar-thumb{background:rgba(0,0,0,0.1);border-radius:3px}

    /***********  CONTROLS  ***********/
    #controls{display:flex;flex-wrap:wrap;gap:10px;padding:16px;border-top:1px solid rgba(0,0,0,0.06)}
    #controls button{
      flex:1 1 48%;padding:10px;border:none;border-radius:var(--radius);
      font-size:14px;font-weight:600;
      background:#e5e7eb;color:var(--text);
      cursor:pointer;transition:background .15s ease,transform .15s ease;
    }
    #controls button:hover{background:#d1d5db}
    #controls button.active{background:var(--accent);color:#fff}

    /***********  VIEWER  ***********/
    #viewerContainer{flex:1;position:relative;min-width:0;display:flex;align-items:center;justify-content:center}
    #viewer{width:100%;height:100%}
    #formulaLabel{
      position:absolute;bottom:12px;left:50%;transform:translateX(-50%);
      background:rgba(255,255,255,0.8);
      backdrop-filter:blur(8px);
      padding:6px 14px;border-radius:var(--radius);
      font-weight:600;font-size:15px;color:var(--text);
      box-shadow:0 4px 10px rgba(0,0,0,0.06);
      pointer-events:none
    }

    footer{
      padding:12px 16px;font-size:13px;text-align:center;color:var(--muted);
    }

    /***********  ANIMATIONS  ***********/
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:none}}

    /***********  RESPONSIVE  ***********/
    @media(max-width:640px){
      #sidebar{position:absolute;z-index:10;height:100%;transform:translateX(-100%);transition:transform .35s ease}
      #sidebar.open{transform:translateX(0)}
      #sidebarToggle{display:block}
    }
  </style>
</head>
<body>
  <!-- mobile sidebar toggle -->
  <button id="sidebarToggle" style="display:none;position:fixed;top:16px;left:16px;background:var(--accent);color:#fff;border:none;border-radius:50%;width:44px;height:44px;z-index:20;font-size:22px;line-height:1;cursor:pointer;box-shadow:var(--shadow);">☰</button>

  <main>
    <aside id="sidebar">
      <div id="fileSection">
        <!-- Roithová Group logo placed above the open button -->
        <img id="rgLogo" src="rglogo.avif" alt="Roithová Group logo" />

        <input type="file" id="fileInput" accept=".xyz" hidden />
        <button id="fileBtn">Open .xyz</button>
      </div>
      <header>Molecules</header>
      <div id="molList"></div>
      <div id="controls">
        <button id="styleBtn">Style: Stick</button>
        <!-- Label mode cycles through Off, Atom (element symbols), and Number (atom index) -->
        <button id="labelMode">Labels: Off</button>
      </div>
    </aside>

    <section id="viewerContainer">
      <div id="viewer"></div>
      <div id="formulaLabel"></div>
    </section>
  </main>
  <footer>MíšaXYZ v1.4 · RSI 2025 · Roithová Group</footer>

  <script>
    /* ================= MOBILE SIDEBAR TOGGLE ================= */
    const sidebar=document.getElementById('sidebar');
    const sidebarToggle=document.getElementById('sidebarToggle');
    sidebarToggle?.addEventListener('click',()=>sidebar.classList.toggle('open'));

    /* ================= SYMBOL & METAL LISTS ================= */
    const symbols=["","H","He","Li","Be","B","C","N","O","F","Ne","Na","Mg","Al","Si","P","S","Cl","Ar","K","Ca","Sc","Ti","V","Cr","Mn","Fe","Co","Ni","Cu","Zn","Ga","Ge","As","Se","Br","Kr","Rb","Sr","Y","Zr","Nb","Mo","Tc","Ru","Rh","Pd","Ag","Cd","In","Sn","Sb","Te","I","Xe","Cs","Ba","La","Ce","Pr","Nd","Pm","Sm","Eu","Gd","Tb","Dy","Ho","Er","Tm","Yb","Lu","Hf","Ta","W","Re","Os","Ir","Pt","Au","Hg","Tl","Pb","Bi","Po","At","Rn","Fr","Ra","Ac","Th","Pa","U","Np","Pu","Am","Cm","Bk","Cf","Es","Fm","Md","No","Lr","Rf","Db","Sg","Bh","Hs","Mt","Ds","Rg","Cn","Nh","Fl","Mc","Lv","Ts","Og"];

    const metals=["Li","Be","Na","Mg","Al","K","Ca","Sc","Ti","V","Cr","Mn","Fe","Co","Ni","Cu","Zn","Ga","Rb","Sr","Y","Zr","Nb","Mo","Tc","Ru","Rh","Pd","Ag","Cd","In","Sn","Cs","Ba","La","Ce","Pr","Nd","Pm","Sm","Eu","Gd","Tb","Dy","Ho","Er","Tm","Yb","Lu","Hf","Ta","W","Re","Os","Ir","Pt","Au","Hg","Tl","Pb","Bi","Po","Fr","Ra","Ac","Th","Pa","U","Np","Pu","Am","Cm","Bk","Cf","Es","Fm","Md","No","Lr","Rf","Db","Sg","Bh","Hs","Mt","Ds","Rg","Cn"];

    /* ================= DOM REFERENCES ================= */
    const fileBtn=document.getElementById("fileBtn");
    const fileInput=document.getElementById("fileInput");
    const molList=document.getElementById("molList");
    const labelModeBtn=document.getElementById("labelMode");
    const styleBtn=document.getElementById("styleBtn");
    const formulaLabel=document.getElementById("formulaLabel");

    /* ================= 3DMOL VIEWER SETUP ================= */
    const viewer=$3Dmol.createViewer("viewer",{backgroundColor:"white"});
    viewer.enableFog(true);
    if(viewer.setFog) viewer.setFog(0.3,1.0);

    /* ================= APP STATE ================= */
    let currentModel=null;
    let molecules=[];
    let currentIndex=-1;
    let labelState=0;
    let styleState=0; // 0 = stick, 1 = ball & stick

    const styleNames=["stick","ballstick"];
    const styleText=["Style: Stick","Style: Ball & Stick"];
    const setStyleText=()=>styleBtn.textContent=styleText[styleState];

    // Display text for label button: Off → Atom → Number
    const modeText=["Labels: Off","Labels: Atom","Labels: Number"];
    const setModeText=()=>labelModeBtn.textContent=modeText[labelState];

    /* ================= FILE HANDLING ================= */
    fileBtn.onclick=()=>fileInput.click();
    fileInput.addEventListener("change",e=>{
      const file=e.target.files[0];
      if(!file) return;
      const reader=new FileReader();
      reader.onload=ev=>{
        try{
          molecules=parseXYZ(ev.target.result);
          populateList();
          if(molecules.length) loadMol(0);
        }catch(err){alert(err.message||err);} };
      reader.readAsText(file);
    });

    function parseXYZ(text){
      const lines=text.replace(/\r/g,"").split("\n");
      let i=0, mols=[];
      while(i<lines.length){
        while(i<lines.length && lines[i].trim()==="") i++;
        if(i>=lines.length) break;
        const n=parseInt(lines[i]);
        if(isNaN(n)||n<=0) throw new Error(`Invalid atom count on line ${i+1}`);
        const header=(lines[i+1]||"").trim();
        const xyzLines=[];const atoms=[];
        for(let j=0;j<n;j++){
          const ln=lines[i+2+j];
          if(!ln) throw new Error("Unexpected end of file while reading atoms");
          const parts=ln.trim().split(/\s+/);
          if(parts.length<4) throw new Error(`Bad atom line on ${i+3+j}`);
          let atom=parts[0];
          if(/^\d+$/.test(atom)) atom=symbols[parseInt(atom,10)]||"X";
          const x=parseFloat(parts[1]),y=parseFloat(parts[2]),z=parseFloat(parts[3]);
          xyzLines.push(`${atom} ${x} ${y} ${z}`);
          atoms.push({elem:atom,x,y,z}); }
        mols.push({header,atoms,xyz:`${n}\n${header}\n${xyzLines.join("\n")}\n`});
        i+=n+2; }
      return mols; }

    /* ================= UI LIST ================= */
    function populateList(){
      molList.innerHTML="";
      molecules.forEach((mol,idx)=>{
        const btn=document.createElement("button");
        btn.textContent=`${idx+1}. ${mol.header||"Molecule"}`;
        btn.onclick=()=>loadMol(idx);
        molList.appendChild(btn); }); }

    /* ================= LOAD & RENDER MOLECULE ================= */
    function loadMol(index){
      if(index<0||index>=molecules.length) return;
      currentIndex=index;
      [...molList.children].forEach((btn,idx)=>btn.classList.toggle("active",idx===index));
      viewer.removeAllLabels();viewer.removeAllModels();
      currentModel=viewer.addModel(molecules[index].xyz,"xyz");
      applyStyle();drawLabels();viewer.zoomTo();viewer.render();updateFormula(); }

    /* ================= STYLE ================= */
    function applyStyle(){
      if(!currentModel) return;
      currentModel.setStyle({},{});
      const stick={radius:0.15};
      const sphere={scale:0.25};
      const choice=styleNames[styleState];
      const isStick=choice==="stick";
      if(isStick){currentModel.setStyle({}, {stick});}
      else{currentModel.setStyle({}, {stick,sphere});currentModel.setStyle({elem:"H"}, {stick,sphere:{scale:0.15}});} 
      const addColoredStyle=(selector,color)=>{
        if(isStick) currentModel.setStyle(selector,{stick:{...stick,color}});
        else currentModel.setStyle(selector,{stick:{...stick,color},sphere:{...sphere,color}});
      };
      addColoredStyle({elem:"N"},"#3b82f6");
      addColoredStyle({elem:"F"},"#006400");
      metals.forEach(el=>addColoredStyle({elem:el},"orange")); }

    styleBtn.onclick=()=>{
      styleState=(styleState+1)%styleNames.length;
      setStyleText();
      applyStyle();
      viewer.render(); };
    setStyleText();

    /* ================= DRAW LABELS ================= */
    function drawLabels(){
      viewer.removeAllLabels();
      if(labelState === 0 || !currentModel) return;
      currentModel.selectedAtoms({}).forEach((a, idx) => {
        const text = labelState === 2 ? String(idx + 1) : a.elem; // 1-based index for numbers
        viewer.addLabel(text, {
          position: { x: a.x, y: a.y, z: a.z },
          fontSize: 12,
          fontColor: "#000000",
          showBackground: false }); }); }

    /* ================= LABEL MODE BUTTON ================= */
    labelModeBtn.onclick=()=>{
      labelState=(labelState+1)%3; // cycle through Off → Atom → Number
      setModeText();
      drawLabels();
      viewer.render(); };
    setModeText();

    /* ================= MOLECULAR FORMULA ================= */
    function updateFormula(){
      const mol=molecules[currentIndex];
      if(!mol){formulaLabel.textContent="";return;}
      const counts={};mol.atoms.forEach(a=>{counts[a.elem]=(counts[a.elem]||0)+1});
      const keys=Object.keys(counts).sort((a,b)=>{
        if(a==="C") return -1; if(b==="C") return 1;
        if(a==="H") return b==="C"?1:-1; if(b==="H") return a==="C"?-1:1;
        return a.localeCompare(b); });
      formulaLabel.textContent=keys.map(k=>k+(counts[k]>1?counts[k]:"")).join(" "); }

    /* ================= RESIZE HANDLER ================= */
    window.addEventListener("resize",()=>viewer.resize());
  </script>
</body>
</html>
